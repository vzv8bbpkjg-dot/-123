<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>iPhoneé¢¨ã‚·ãƒŠãƒªã‚ªã‚¢ãƒ—ãƒª PWAå®Œå…¨ç‰ˆï¼ˆç·¨é›†å¯¾å¿œï¼‰</title>
<link rel="manifest" href="manifest.json">
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Segoe UI",sans-serif;overflow:hidden;background:#111;color:#fff;background-size:cover;background-position:center;}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;overflow-y:auto;padding:20px;background:rgba(0,0,0,0.9);}
.screen.active{display:flex;}
#lockScreen{display:flex;flex-direction:column;justify-content:flex-start;color:#fff;padding:20px;}
#date{font-size:24px;margin-bottom:5px;text-align:center;}
#time{font-size:48px;font-weight:bold;letter-spacing:2px;text-align:center;margin-bottom:20px;}
.iconBar{display:flex;justify-content:space-around;width:100%;position:absolute;bottom:20px;}
.iconButton{font-size:32px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.3);cursor:pointer;transition:0.2s transform,0.2s background;}
.iconButton:hover{transform: scale(1.2);background: rgba(255,255,255,0.2);}
.card{width:calc(33.33% - 10px);border:1px solid #333;border-radius:8px;padding:5px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.5);}
.card img{width:100%;height:auto;border-radius:5px;}
.reward-media img,.reward-media video,.reward-media audio{width:200px;margin-top:5px;border-radius:8px;}
.backBtn{margin-bottom:20px;padding:10px 15px;background:#007aff;color:#fff;border-radius:10px;cursor:pointer;width:fit-content;}
.notify{position:fixed;top:-80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:12px;z-index:999;transition: top 0.5s ease, opacity 0.5s;}
.notify.show{top:20px;opacity:1;}
#fullScreenOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);justify-content:center;align-items:center;z-index:1000;flex-direction:column;}
#fullScreenOverlay button{position:absolute;top:20px;right:20px;padding:10px 15px;background:#fff;border:none;border-radius:5px;cursor:pointer;}
#chatMessages{flex:1;overflow-y:auto;margin-bottom:10px;}
#chatMessages div{opacity:0;transform: translateY(10px);animation: fadeInMsg 0.3s forwards;margin-bottom:12px;padding:12px 16px;border-radius:20px;max-width:75%;display:flex;flex-direction:column;word-break:break-word;white-space:pre-wrap;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
.chat-bot{background:#0b3d91;color:#fff;align-self:flex-start;border-top-left-radius:0;}
.chat-bot::after{content:"";position:absolute;left:-8px;bottom:0;width:0;height:0;border-top:10px solid #0b3d91;border-right:10px solid transparent;}
.user-msg{background:#ffe066;color:#000;align-self:flex-end;border-top-right-radius:0;}
.user-msg::after{content:"";position:absolute;right:-8px;bottom:0;width:0;height:0;border-top:10px solid #ffe066;border-left:10px solid transparent;}
#chatMessages div img,#chatMessages div video,#chatMessages div audio{margin-top:5px;border-radius:12px;max-width:100%;}
@keyframes fadeInMsg{to{opacity:1;transform:translateY(0);}}
.mediaPreview img,.mediaPreview video,.rewardPreview img,.rewardPreview video{width:60px;height:40px;object-fit:cover;border-radius:8px;cursor:pointer;}
.mediaPreview audio,.rewardPreview audio{width:120px;}
.groupHeading{cursor:pointer; font-weight:bold; margin:10px 0 5px; display:flex; align-items:center; justify-content:space-between;}
.newBadge{background:red;color:#fff;font-size:12px;padding:2px 5px;border-radius:5px;margin-left:5px;}
@media(max-width:600px){.card{width:calc(50% - 10px);}}

/* é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã®ã‚«ãƒ¼ãƒ‰ã‚‚ã‚¹ãƒãƒ›ã§2åˆ— */
#templateList > div > div.card {
  width: calc(50% - 10px);
}

@media(max-width: 400px){ 
  #templateList > div > div.card {
    width: 100%; /* å°ã•ã„ç”»é¢ã§ã¯1åˆ—ã« */
  }
}
</style>
</head>
<body>
<div id="notify" class="notify"></div>

<!-- ãƒ­ãƒƒã‚¯ç”»é¢ -->
<div id="lockScreen">
  <div id="date"></div>
  <div id="time"><span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span></div>
  <div class="iconBar">
    <div class="iconButton" id="heartBtn">ğŸ’›</div>
    <div class="iconButton" id="cameraBtn">ğŸ“¸</div>
    <div class="iconButton" id="mailBtn">ğŸ’Œ</div>
    <div class="iconButton" id="bookBtn">ğŸ“–</div>
    <div class="iconButton" id="resetBtn">ğŸ’£</div>
  </div>
</div>

<!-- ãƒ¡ãƒ¼ãƒ«ç”»é¢ -->
<div id="mailScreen" class="screen">
  <div class="backBtn" onclick="goBack()">â† æˆ»ã‚‹</div>
  <input id="searchInput" placeholder="æ¤œç´¢" style="margin-bottom:10px;padding:5px;">
  <div id="scenarioList" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
<div id="chatScreen" class="screen">
  <div class="backBtn" onclick="goBack()">â† æˆ»ã‚‹</div>
  <div id="chatMessages"></div>
  <div style="display:flex;">
    <input id="chatInput" type="text" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:5px;">
    <button id="sendBtn" style="padding:8px 12px;margin-left:5px;background:#007aff;color:#fff;border:none;border-radius:5px;">é€ä¿¡</button>
  </div>
</div>

<!-- é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ -->
<div id="devScreen" class="screen">
  <div class="backBtn" onclick="goBack()">â† æˆ»ã‚‹</div>
  <h2>é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰</h2>
  <button onclick="downloadFullAppZip()">â˜… ãƒ•ãƒ«ZIPå‡ºåŠ›</button>
  <input type="file" id="importZip" accept=".zip" style="display:none;">
  <button onclick="document.getElementById('importZip').click()">ğŸ“‚ ZIPèª­ã¿è¾¼ã¿</button>
  <h3>æ–°è¦ã‚·ãƒŠãƒªã‚ªç™»éŒ² / ç·¨é›†</h3>
  <input type="hidden" id="editingIndex">
  ä»¶å:<input id="tmplTitle" placeholder="ä»¶å" style="width:200px;">
  ã‚¸ãƒ£ãƒ³ãƒ«:<input id="tmplGenre" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«" style="width:150px;"><br><br>
  ã‚µãƒ ãƒã‚¤ãƒ«:<img id="tmplThumbPreview" style="width:100px;height:60px;border:1px solid #ccc;display:block;margin-bottom:5px;">
  <input type="file" id="thumbnailInput" accept="image/*">
  <input type="hidden" id="tmplThumb"><br>
  æ—¥ä»˜:<input id="tmplDate" type="date">
  æ™‚é–“:<input id="tmplTime" type="time">
  æ›œæ—¥(0-æ—¥æ›œ):<input id="tmplWeek" type="number" min="0" max="6">
  åˆè¨€è‘‰:<input id="tmplPass" placeholder="åˆè¨€è‘‰"><br><br>

  ã‚°ãƒ«ãƒ¼ãƒ—:
  <select id="tmplGroupSelect">
    <option value="">æ–°è¦ä½œæˆ</option>
  </select>
  <input type="text" id="tmplNewGroup" placeholder="æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—å"><br><br>

  <h4>ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«</h4>
  <div id="chatSets"></div>
  <button onclick="addChatSet()">+ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ãƒƒãƒˆè¿½åŠ </button><br><br>
  <button onclick="saveTemplate()">ä¿å­˜</button>

 <h3>ç™»éŒ²æ¸ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
<input type="text" id="devSearchInput" placeholder="æ¤œç´¢ (ä»¶åãƒ»ã‚¸ãƒ£ãƒ³ãƒ«)" style="margin-bottom:10px;padding:5px;width:100%;">
<div id="templateList"></div>
</div>

<input type="file" id="wallpaperInput" accept="image/*" style="display:none;">
<div id="fullScreenOverlay">
  <button onclick="closeFullScreen()">é–‰ã˜ã‚‹</button>
  <div id="fullScreenContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// ---------- IndexedDB ----------
let db, templates=[], currentChat=null, chatIndex=0, autoTimeouts=[];
function initDB(){
  const request=indexedDB.open('iPhoneSimAppDB',1);
  request.onupgradeneeded=e=>{db=e.target.result; db.createObjectStore('appData',{keyPath:'key'});};
  request.onsuccess=e=>{db=e.target.result; loadAppData();};
}
function saveData(key,value){const tx=db.transaction('appData','readwrite');const store=tx.objectStore('appData');store.put({key,value});}
function loadData(key){return new Promise(res=>{const tx=db.transaction('appData','readonly');const store=tx.objectStore('appData');const req=store.get(key); req.onsuccess=e=>res(e.target.result?e.target.result.value:null);});}
function loadAppData(){
  loadData('wallpaper').then(val=>{if(val) document.body.style.backgroundImage=`url(${val})`;});
  loadData('templates').then(val=>{if(val) templates=val; updateGroupOptions(); renderTemplates(); renderScenarioList();});
}

// ---------- æ™‚è¨ˆ ----------
function updateTime(){
  const now=new Date();
  document.getElementById('date').innerText=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
  document.getElementById('hours').innerText=String(now.getHours()).padStart(2,'0');
  document.getElementById('minutes').innerText=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('seconds').innerText=String(now.getSeconds()).padStart(2,'0');
}
setInterval(updateTime,1000); updateTime();

// ---------- é€šçŸ¥ ----------
function notify(msg){const n=document.getElementById('notify'); n.innerText=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),3000);}

// ---------- ç”»é¢åˆ‡æ›¿ ----------
const lockScreen=document.getElementById('lockScreen'),
mailScreen=document.getElementById('mailScreen'),
chatScreen=document.getElementById('chatScreen'),
devScreen=document.getElementById('devScreen');
document.getElementById('mailBtn').onclick=()=>{lockScreen.style.display='none'; mailScreen.classList.add('active'); renderScenarioList();};
document.getElementById('bookBtn').onclick=()=>{lockScreen.style.display='none'; devScreen.classList.add('active'); renderTemplates(); updateGroupOptions();};
document.getElementById('cameraBtn').onclick=()=>{document.getElementById('wallpaperInput').click();};
document.getElementById('heartBtn').onclick=()=>{document.getElementById('importZip').click();};

document.getElementById('wallpaperInput').addEventListener('change',e=>{if(!e.target.files[0])return;const r=new FileReader();r.onload=ev=>{document.body.style.backgroundImage=`url(${ev.target.result})`; saveData('wallpaper',ev.target.result);}; r.readAsDataURL(e.target.files[0]);});
document.getElementById('thumbnailInput').addEventListener('change', e=>{if(!e.target.files[0])return; const r=new FileReader(); r.onload=ev=>{document.getElementById('tmplThumbPreview').src=ev.target.result; document.getElementById('tmplThumb').value=ev.target.result;}; r.readAsDataURL(e.target.files[0]);});
function goBack(){mailScreen.classList.remove('active'); chatScreen.classList.remove('active'); devScreen.classList.remove('active'); lockScreen.style.display='flex'; document.getElementById('chatMessages').scrollTop=0;}

document.getElementById('resetBtn').onclick = () => {
    if(!confirm("ğŸ’£ æœ¬å½“ã«å…¨ã‚·ãƒŠãƒªã‚ªã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

    // localStorage ã® NEW ãƒãƒƒã‚¸ç”¨ã‚’æ¶ˆã™
    templates.forEach(t => localStorage.removeItem(`read_${t.title}`));

// IndexedDB chatState ã‚’ç©ºã«ã™ã‚‹ï¼ˆIDæ–¹å¼ï¼‰
templates.forEach(t => {
  if(!t.id) t.id = Date.now() + '_' + Math.floor(Math.random() * 1000); // IDãŒç„¡ã‘ã‚Œã°ä½œæˆ
  saveData(`chatState_${t.id}`, []);
});

    // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚‚ç©ºã«
    currentChat = null;
    chatIndex = 0;
    innerMsgIndex = 0;
    clearAutoTimeouts();
    document.getElementById('chatMessages').innerHTML = '';

    // ã‚·ãƒŠãƒªã‚ªä¸€è¦§å†æç”»
    renderScenarioList();

    notify("ğŸ’£ ã‚·ãƒŠãƒªã‚ªã‚’å…¨ã¦æœ€åˆã‹ã‚‰å†ãƒ—ãƒ¬ã‚¤å¯èƒ½ã«ã—ã¾ã—ãŸ");
};

// ---------- ãƒãƒ£ãƒƒãƒˆ ----------

function displayNextMessage(){
  if(!currentChat) return;

  const chat = currentChat.chats[chatIndex];
  if(!chat) return;

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•ã§é †ç•ªè¡¨ç¤º
  if(innerMsgIndex < chat.messages.length){
    const msg = chat.messages[innerMsgIndex];
    appendMessage(msg.text, false, msg.media || []);
    innerMsgIndex++;

    saveChatState(currentChat.title);

    setTimeout(displayNextMessage, 800);
    return;
  }

  // ã“ã®ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒçµ‚ã‚ã£ãŸ
  innerMsgIndex = 0;

  // åˆ†å²ãŒã‚ã‚Œã°è¡¨ç¤º
  if(chat.branches && chat.branches.length > 0){
    displayBranchButtons(chat.branches);
    return;
  }

  // æ¬¡ã®ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒãƒˆã¸
  chatIndex++;

  // æ¬¡ãŒã‚ã‚Œã°è‡ªå‹•å†ç”Ÿ
  if(currentChat.chats[chatIndex]){
    setTimeout(displayNextMessage, 800);
  }
}

function openChat(template, forceReset = false) {
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‚’è¨­å®š
    currentChat = JSON.parse(JSON.stringify(template));
    chatIndex = 0;
    innerMsgIndex = 0; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ã†ã®ã§ let ã¯ä¸è¦

    // ãƒãƒ£ãƒƒãƒˆç”»é¢åˆæœŸåŒ–
    document.getElementById('chatMessages').innerHTML = '';
    chatScreen.classList.add('active');
    mailScreen.classList.remove('active');
    clearAutoTimeouts();

 // IDãŒç„¡ã‘ã‚Œã°ä½œã‚‹
if(!template.id) template.id = Date.now() + '_' + Math.floor(Math.random() * 1000);

// IndexedDBã‹ã‚‰ä»¥å‰ã®ãƒãƒ£ãƒƒãƒˆçŠ¶æ…‹ã‚’å–å¾—
loadData(`chatState_${template.id}`).then(state => {
    if (forceReset || !state) {
        // å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãªã—ã®å ´åˆã¯ç©ºé…åˆ—ä¿å­˜
        saveData(`chatState_${template.id}`, []);
        chatIndex = 0;
        innerMsgIndex = 0;
    } else if (state.length > 0) {
        // éå»ã®ãƒãƒ£ãƒƒãƒˆã‚’å¾©å…ƒ
        state.forEach(c => appendMessage(c.text, c.isUser, c.media));

            // ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒãƒˆå˜ä½ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨ˆç®—
            chatIndex = 0;
            innerMsgIndex = 0;
            if (currentChat && currentChat.chats) {
                let msgCount = 0;
                for (let i = 0; i < currentChat.chats.length; i++) {
                    const set = currentChat.chats[i];
                    if (msgCount + set.messages.length <= state.length) {
                        chatIndex = i + 1;
                        msgCount += set.messages.length;
                    } else {
                        innerMsgIndex = state.length - msgCount;
                        chatIndex = i;
                        break;
                    }
                }
            }
        }

        // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è‡ªå‹•å†ç”Ÿ
        if (innerMsgIndex < currentChat.chats[chatIndex]?.messages.length) {
            setTimeout(displayNextMessage, 500);
        }
    });
}

function appendMessage(text,isUser,media=[]){
  const container=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.className=isUser?'user-msg':'chat-bot';
  div.textContent=text;
  media.forEach(m=>div.appendChild(createMediaElement(m)));
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
  return div;
}

function createMediaElement(url){
  let el;
  if(url.startsWith('data:video')){el=document.createElement('video');el.src=url;el.controls=true;}
  else if(url.startsWith('data:audio')){el=document.createElement('audio');el.src=url;el.controls=true;}
  else{el=document.createElement('img');el.src=url;}
  el.style.marginTop='5px';
  el.style.borderRadius='12px';
  el.style.maxWidth='100%';
  el.onclick=()=>openFullScreen(url, el.tagName.toLowerCase());
  return el;
}

let innerMsgIndex = 0;

function displayBranchButtons(branches){
  if(!branches || branches.length===0) return;
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.style.display='flex'; div.style.gap='8px'; div.style.flexWrap='wrap';
  branches.forEach(b=>{
    const btn = document.createElement('button');
    btn.textContent = b.word;
    btn.style.padding='5px 10px'; btn.style.borderRadius='10px'; btn.style.background='#00b894';
    btn.style.color='#fff'; btn.style.border='none';
    btn.onclick = () => {
      const targetTemplate = templates.find(t => t.title === b.targetTemplate);
      if(targetTemplate){
        currentChat = JSON.parse(JSON.stringify(targetTemplate));
        chatIndex = b.targetChatIndex;
        document.getElementById('chatMessages').innerHTML='';
        displayNextMessage();
      } else {notify("åˆ†å²å…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");}
    };
    div.appendChild(btn);
  });
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

document.getElementById('sendBtn').onclick=()=>{
  if(!currentChat) return;
  const input=document.getElementById('chatInput'); const val=input.value.trim(); if(!val) return;
 const prevChat = currentChat.chats[chatIndex];
  const container=document.getElementById('chatMessages');
  appendMessage(val,true);
  saveChatState(currentChat.title);
  if(prevChat.answer && prevChat.answer.trim()!==""){
    if(val===prevChat.answer){
  // â˜… ã”è¤’ç¾ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’é †ç•ªã«è¡¨ç¤º
  let idx = 0;
  function showReward(){
    if(idx < prevChat.rewardMedia.length){
      appendMessage('', false, [prevChat.rewardMedia[idx]]);
      idx++;
      setTimeout(showReward, 500); // 0.5ç§’ã”ã¨ã«è¡¨ç¤º
    } else {
      input.value='';
      displayNextMessage();
    }
  }
  showReward();
}
else {appendMessage(prevChat.wrongMsg && prevChat.wrongMsg.trim() !== "" ? prevChat.wrongMsg : "ã‚‚ã†ä¸€åº¦è€ƒãˆã¦", false); input.value=''; container.scrollTop=container.scrollHeight;}
  } else { input.value=''; displayNextMessage(); }
}

function saveChatState(title){
  const messages=document.querySelectorAll('#chatMessages > div'); const state=[];
  messages.forEach(m=>{
    const mediaArr=[];
    m.querySelectorAll('img,video,audio').forEach(md=>mediaArr.push(md.src));
    state.push({text:m.childNodes[0]?.nodeValue||'',isUser:m.classList.contains('user-msg'),media:mediaArr});
  });

saveData(`chatState_${currentChat.id}`, state);

}

function clearAutoTimeouts(){autoTimeouts.forEach(t=>clearTimeout(t)); autoTimeouts=[];}

// ---------- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ ----------
function openFullScreen(src,type){
  const overlay = document.getElementById('fullScreenOverlay');
  const content = document.getElementById('fullScreenContent');
  content.innerHTML = '';
  if(type === 'img'){const img=document.createElement('img');img.src=src;img.style.maxWidth='95%';img.style.maxHeight='95%';img.style.borderRadius='12px';content.appendChild(img);}
  else if(type === 'video'){const v=document.createElement('video');v.src=src;v.controls=true;v.autoplay=true;v.style.maxWidth='95%';v.style.maxHeight='95%';v.style.borderRadius='12px';content.appendChild(v);}
  else if(type === 'audio'){const a=document.createElement('audio');a.src=src;a.controls=true;a.autoplay=true;content.appendChild(a);}
  overlay.style.display = 'flex';
}
function closeFullScreen(){document.getElementById('fullScreenOverlay').style.display='none'; document.getElementById('fullScreenContent').innerHTML='';}

// ---------- ZIP ----------
function downloadFullAppZip(){
  const zip=new JSZip();
  zip.file("index.html", document.documentElement.outerHTML);
  zip.file("templates.json", JSON.stringify(templates,null,2));
  zip.generateAsync({type:"blob"}).then(content=>{
    const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download=`iPhoneSimApp_${Date.now()}.zip`; a.click(); notify("å®Œæˆç‰ˆZIPã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
  });
}
document.getElementById('importZip').addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  JSZip.loadAsync(file).then(zip=>{
   const tmplFile = zip.file("templates.json");
if(!tmplFile){notify("templates.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return;}
tmplFile.async("string").then(str=>{
      const imported=JSON.parse(str);
     imported.forEach(t=>{
  templates.push(t);

});
      saveData('templates',templates); updateGroupOptions(); renderTemplates(); renderScenarioList(); notify(`ZIPèª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ${imported.length}ä»¶ï¼‰`);
    });
  });
});

// ---------- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† ----------
function addChatSet(chat=null){
  const container=document.getElementById('chatSets');
  const div=document.createElement('div');
  div.style.border='1px solid #ccc'; div.style.padding='10px'; div.style.marginBottom='10px'; div.style.borderRadius='8px';

  div.innerHTML=`
   <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè¤‡æ•°ãƒ»é †ç•ªã‚ã‚Šï¼‰:</label>
<div class="messagesContainer"></div>
<button type="button" onclick="addMessage(this)">ï¼‹ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ </button>
    <label>ãƒ’ãƒ³ãƒˆç”¨ãƒ¡ãƒ‡ã‚£ã‚¢:</label><br>
    <input type="file" class="mediaFiles" multiple accept="image/*,video/*,audio/*"><br>
    <div class="mediaPreview" style="display:flex;gap:5px;margin-top:5px;"></div><br>
    <label>æ­£è§£:</label><br>
    <input class="answer"><br><br>
    <label>ä¸æ­£è§£æ™‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label><br>
    <input class="wrongMsg" placeholder="ä¾‹ï¼šã¡ãŒã†ã‚ˆã€ã‚‚ã†ä¸€å›â™¡"><br><br>
    <label>æ­£è§£æ™‚ã”è¤’ç¾ãƒ¡ãƒ‡ã‚£ã‚¢:</label><br>
    <input type="file" class="rewardFiles" multiple accept="image/*,video/*,audio/*"><br>
    <div class="rewardPreview" style="display:flex;gap:5px;margin-top:5px;"></div><br>
    <label>åˆ†å²è¨­å®šï¼ˆæœ€å¤§4ï¼‰:</label><br>
    <div class="branchesContainer"></div>
    <button onclick="addBranch(this)">+ åˆ†å²è¿½åŠ </button>
  `;
  container.appendChild(div);

const delSetBtn = document.createElement('button');
delSetBtn.textContent = 'ğŸ—‘ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚’å‰Šé™¤';
delSetBtn.style.background = '#ff7675';
delSetBtn.style.color = '#fff';
delSetBtn.style.border = 'none';
delSetBtn.style.borderRadius = '8px';
delSetBtn.style.marginBottom = '10px';
delSetBtn.onclick = () => {
  if(confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
    div.remove();
  }
};
div.prepend(delSetBtn);

  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
 if(chat){
// æ­£è§£ãƒ»ä¸æ­£è§£ã‚’ input ã«åæ˜ 
div.querySelector('.answer').value = chat.answer || '';
div.querySelector('.wrongMsg').value = chat.wrongMsg || '';

  // ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‡ã‚£ã‚¢
  if(chat.media) chat.media.forEach(m=>{
    const el = createMediaElement(m);
    div.querySelector('.mediaPreview').appendChild(el);
  });
  // ã”è¤’ç¾ãƒ¡ãƒ‡ã‚£ã‚¢
  if(chat.rewardMedia) chat.rewardMedia.forEach(m=>{
    const el = createMediaElement(m);
    div.querySelector('.rewardPreview').appendChild(el);
  });
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if(chat.messages){
    chat.messages.forEach(msgData=>{
      addMessage(div.querySelector('button'), msgData);
    });
  }
  // åˆ†å²
  if(chat.branches){
    chat.branches.forEach(b=>{
      addBranch(div.querySelector('button'));
      const lastBranch = div.querySelector('.branchesContainer').lastElementChild;
      lastBranch.querySelector('.branchWord').value = b.word;
      const sel = lastBranch.querySelector('.branchTargetSelect');
      templates.forEach((t,i)=>{ 
        const opt=document.createElement('option'); 
        opt.value=i; 
        opt.textContent=`[${t.group||"ç„¡æ‰€å±"}] ${i+1}: ${t.title}`; 
        sel.appendChild(opt); 
      });
      const idx = templates.findIndex(t=>t.title===b.targetTemplate);
      if(idx>=0) sel.value=idx;
    });
  }
}

  // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const mediaInput = div.querySelector('.mediaFiles');
  const mediaPreview = div.querySelector('.mediaPreview');
  mediaInput.addEventListener('change', e=>{
    mediaPreview.innerHTML='';
    Array.from(e.target.files).forEach(file=>{
      const url = URL.createObjectURL(file);
      let el; if(file.type.startsWith('image/')) el=document.createElement('img');
      else if(file.type.startsWith('video/')) el=document.createElement('video');
      else if(file.type.startsWith('audio/')) el=document.createElement('audio');
      else return;
      el.src=url; el.style.cursor='pointer'; el.onclick=()=>openFullScreen(url,file.type.split('/')[0]);
      el.style.borderRadius='8px'; if(file.type.startsWith('audio')) el.style.width='120px'; else{el.style.width='60px'; el.style.height='40px';}
      mediaPreview.appendChild(el);
    });
  });

  const rewardInput = div.querySelector('.rewardFiles');
  const rewardPreview = div.querySelector('.rewardPreview');
  rewardInput.addEventListener('change', e=>{
    rewardPreview.innerHTML='';
    Array.from(e.target.files).forEach(file=>{
      const url = URL.createObjectURL(file);
      let el; if(file.type.startsWith('image/')) el=document.createElement('img');
      else if(file.type.startsWith('video/')) el=document.createElement('video');
      else if(file.type.startsWith('audio/')) el=document.createElement('audio');
      else return;
      el.src=url; el.style.cursor='pointer'; el.onclick=()=>openFullScreen(url,file.type.split('/')[0]);
      el.style.borderRadius='8px'; if(file.type.startsWith('audio')) el.style.width='120px'; else{el.style.width='60px'; el.style.height='40px';}
      rewardPreview.appendChild(el);
    });
  });
}

function addMessage(btn, data=null){
  const container = btn.parentElement.querySelector('.messagesContainer');
  const div = document.createElement('div');
  div.style.border = '1px solid #444';
  div.style.padding = '8px';
  div.style.marginBottom = '8px';
  div.style.borderRadius = '8px';

 div.innerHTML = `
  <textarea class="msgText" rows="3" style="width:100%;" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"></textarea>

  <input type="file" class="msgMedia" multiple accept="image/*,video/*,audio/*">

  <div class="mediaPreview" style="display:flex;gap:5px;"></div>

  <button type="button"
    style="
      background:#d63031;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:4px 8px;
      margin-top:6px;
    "
    onclick="this.parentElement.remove()"
  >ğŸ—‘ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤</button>
`;
container.appendChild(div);
  container.appendChild(div);

  if(data){
    div.querySelector('.msgText').value = data.text;
    data.media.forEach(m=>{
      const img=document.createElement('img');
      img.src=m;
      img.style.width='60px';
      img.style.borderRadius='8px';
      div.querySelector('.mediaPreview').appendChild(img);
    });
  }
}

// ---------- åˆ†å² ----------
function addBranch(btn){
  const container=btn.parentElement.querySelector('.branchesContainer');
  if(container.children.length>=4){notify("åˆ†å²ã¯æœ€å¤§4ã¤ã§ã™"); return;}
  const div=document.createElement('div'); div.style.marginBottom='5px';
  div.innerHTML=`
    åˆ†å²ãƒ¯ãƒ¼ãƒ‰:<input class="branchWord" placeholder="ãƒ¯ãƒ¼ãƒ‰">
    é·ç§»å…ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:<select class="branchTargetSelect"></select>
  `;
  container.appendChild(div);
  updateBranchTargets(div.querySelector('.branchTargetSelect'));
}
function updateBranchTargets(select){
  select.innerHTML='';
  templates.forEach((t,i)=>{
    const opt=document.createElement('option');
    opt.value=i; opt.textContent=`[${t.group||"ç„¡æ‰€å±"}] ${i+1}: ${t.title}`;
    select.appendChild(opt);
  });
}

function updateGroupOptions(){
  const select = document.getElementById('tmplGroupSelect');
  const existingGroups = [...new Set(templates.map(t=>t.group).filter(g=>g))];
  select.innerHTML='<option value="">æ–°è¦ä½œæˆ</option>';
  existingGroups.forEach(g=>{const opt = document.createElement('option'); opt.value=g; opt.textContent=g; select.appendChild(opt);});
}

// ---------- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ ----------

function renderTemplates(){
  const container = document.getElementById('templateList');
  container.innerHTML = '';

const search = document.getElementById('devSearchInput').value.toLowerCase();

  // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«æ•´ç†
 const groups = {};
templates.forEach((t, i) => {
  // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä»¶åãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰
  if(search && !t.title.toLowerCase().includes(search) && !t.genre.toLowerCase().includes(search)) return;

  const g = t.group || 'ãã®ä»–';
  if (!groups[g]) groups[g] = [];
  groups[g].push({template: t, index: i});
});

  for(const [groupName, list] of Object.entries(groups)){
    // ã‚°ãƒ«ãƒ¼ãƒ—è¦‹å‡ºã—
    const heading = document.createElement('div');
    heading.style.fontWeight = 'bold';
    heading.style.marginTop = '10px';
    heading.style.marginBottom = '5px';
    heading.textContent = groupName;
    container.appendChild(heading);

    // 2åˆ—ã«ã™ã‚‹ãŸã‚ã®flexã‚³ãƒ³ãƒ†ãƒŠ
    const flexDiv = document.createElement('div');
    flexDiv.style.display = 'flex';
    flexDiv.style.flexWrap = 'wrap';
    flexDiv.style.gap = '10px';

    list.forEach(({template, index}) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.width = 'calc(50% - 10px)'; // 2åˆ—
      card.innerHTML = `
        <img src="${template.thumb}"><br>
        ${template.title} 
        <button onclick="editTemplate(${index})">ç·¨é›†</button> 
        <button onclick="deleteTemplate(${index})">å‰Šé™¤</button>
      `;
      flexDiv.appendChild(card);
    });

    container.appendChild(flexDiv);
  }
}

function editTemplate(i){
  const t = templates[i];
  document.getElementById('editingIndex').value = i;
  document.getElementById('tmplTitle').value = t.title;
  document.getElementById('tmplGenre').value = t.genre;
  document.getElementById('tmplThumbPreview').src = t.thumb;
  document.getElementById('tmplThumb').value = t.thumb;
  document.getElementById('tmplDate').value = t.date;
  document.getElementById('tmplTime').value = t.time;
  document.getElementById('tmplWeek').value = t.week;
  document.getElementById('tmplPass').value = t.pass;
  if(t.group){document.getElementById('tmplGroupSelect').value = t.group;}
  document.getElementById('chatSets').innerHTML='';
  t.chats.forEach(c=>addChatSet(c));
  devScreen.classList.add('active'); lockScreen.style.display='none';
}

function deleteTemplate(i){templates.splice(i,1); saveData('templates',templates); renderTemplates(); renderScenarioList(); notify("å‰Šé™¤ã—ã¾ã—ãŸ");}

// ---------- ã‚·ãƒŠãƒªã‚ªä¸€è¦§ ----------
function renderScenarioList(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const container=document.getElementById('scenarioList'); container.innerHTML='';
  const groups = {};
  templates.forEach(t=>{
    if(search && !t.title.toLowerCase().includes(search) && !t.genre.toLowerCase().includes(search)) return;
    const g = t.group || 'ãã®ä»–';
    if(!groups[g]) groups[g]=[];
    groups[g].push(t);
  });
  for(const [groupName, list] of Object.entries(groups)){
    const heading = document.createElement('div');
    heading.className='groupHeading';
    const titleSpan = document.createElement('span'); titleSpan.textContent=groupName;
    const toggle = document.createElement('span'); toggle.textContent='â–¼'; heading.append(titleSpan, toggle);
    container.appendChild(heading);

    const cardsDiv = document.createElement('div'); cardsDiv.style.display='flex'; cardsDiv.style.flexWrap='wrap'; cardsDiv.style.gap='10px';
    list.forEach(t=>{
      const now=new Date();
      let locked=false;
      const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      const nowTimeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      if ((t.date && todayStr < t.date) || (t.time && nowTimeStr < t.time) || (t.week && now.getDay() != t.week)) {locked = true;}
      if (t.pass) {locked = true;}

      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`<img src="${t.thumb}" style="filter:${locked?'blur(5px)':'none'}"><br>${t.title}`;
      if(!locked && !localStorage.getItem(`read_${t.title}`)){const newBadge = document.createElement('span'); newBadge.className='newBadge'; newBadge.textContent='NEW'; card.appendChild(newBadge);}

card.onclick = () => {
  openChat(t); // å‰å›ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ãŸã„å ´åˆ
  // openChat(t, true); // æ¯å›æ–°è¦ã§é–‹ããŸã„å ´åˆ
};
    
      cardsDiv.appendChild(card);
    });
    container.appendChild(cardsDiv);
    heading.onclick=()=>{cardsDiv.style.display=cardsDiv.style.display==='none'?'flex':'none'; toggle.textContent=cardsDiv.style.display==='none'?'â–¶':'â–¼';};
  }
}
document.getElementById('searchInput').addEventListener('input',renderScenarioList);
initDB();

document.getElementById('devSearchInput').addEventListener('input', renderTemplates);

</script>
</body>
</html>